<html><head><title>Initialise Tissue Micro Array</title>
</head><body>
    

    <!-- Input Form -->
    <form id="experimentalDataForm">
        <!-- Cycling through experimental data -->
    <div id="confidenceLevelControls">
        <button onclick="cycleExperiments(-1)">
            &lt;
        </button>
        <!-- <p id="experimentDisplay">Experiment:</p> -->
        <!-- Have to select a datafile -->
        <label for="experiment_data_id">Experiment ID:</label>
        <input type="text" name="experiment_data_id" id="experiment_data_id" readonly="" required="" value="test1010">
        
        <button onclick="cycleExperiments(1)">
            &gt;
        </button>
    </div>
    <!-- Have to select a datafile -->
    <label for="tissue_micro_array">Data File:</label>
    <input type="text" name="tissue_micro_array" id="tissue_micro_array" readonly="" required="" value="vignetteRegion.ome.tiff">
    <br>
    <!-- nuclear stain, needs to populated in template -->
    
    <label for="nuclear_stain">Choose Nuclear Stain:</label>
     <select name="nuclear_stain" id="nuclear_stain" required=""><option value="DAPI">DAPI</option><option value="LMP1">LMP1</option><option value="HLA-A">HLA-A</option><option value="CD4">CD4</option><option value="LAG3">LAG3</option><option value="CD20">CD20</option><option value="E1BS (EBNA1)">E1BS (EBNA1)</option><option value="tp (LMP2A)">tp (LMP2A)</option><option value="Vimentin">Vimentin</option><option value="CD30">CD30</option><option value="E-cadherin">E-cadherin</option><option value="CD31">CD31</option><option value="EBNA2">EBNA2</option><option value="CD45RO">CD45RO</option><option value="SMA">SMA</option><option value="CD3e">CD3e</option><option value="IDO1">IDO1</option><option value="CD34">CD34</option><option value="CD11c">CD11c</option><option value="GranzymeB">GranzymeB</option><option value="CD19">CD19</option><option value="CollagenIV">CollagenIV</option><option value="CD79a">CD79a</option><option value="CD14">CD14</option><option value="FoxP3">FoxP3</option><option value="CD57">CD57</option><option value="CD45">CD45</option><option value="CD163">CD163</option><option value="CD278 (ICOS)">CD278 (ICOS)</option><option value="HLA-DR">HLA-DR</option><option value="PD1">PD1</option><option value="PDL1">PDL1</option><option value="CD21">CD21</option><option value="CD11b">CD11b</option><option value="PAX5">PAX5</option><option value="CD38">CD38</option><option value="EBVEaD">EBVEaD</option><option value="CD8">CD8</option><option value="CD44">CD44</option><option value="TIM3">TIM3</option><option value="Ki67">Ki67</option><option value="Pan-Cytokeratin">Pan-Cytokeratin</option><option value="CD68">CD68</option></select>   
    <br>
     
    <!-- nuclear markers, needs to populated in template -->
    
        <label for="nuclear_markers">Choose Nuclear Channel Markers:</label>
        <select multiple="" name="nuclear_markers" id="nuclear_markers" required=""><option value="DAPI">DAPI</option><option value="LMP1">LMP1</option><option value="HLA-A">HLA-A</option><option value="CD4">CD4</option><option value="LAG3">LAG3</option><option value="CD20">CD20</option><option value="E1BS (EBNA1)">E1BS (EBNA1)</option><option value="tp (LMP2A)">tp (LMP2A)</option><option value="Vimentin">Vimentin</option><option value="CD30">CD30</option><option value="E-cadherin">E-cadherin</option><option value="CD31">CD31</option><option value="EBNA2">EBNA2</option><option value="CD45RO">CD45RO</option><option value="SMA">SMA</option><option value="CD3e">CD3e</option><option value="IDO1">IDO1</option><option value="CD34">CD34</option><option value="CD11c">CD11c</option><option value="GranzymeB">GranzymeB</option><option value="CD19">CD19</option><option value="CollagenIV">CollagenIV</option><option value="CD79a">CD79a</option><option value="CD14">CD14</option><option value="FoxP3">FoxP3</option><option value="CD57">CD57</option><option value="CD45">CD45</option><option value="CD163">CD163</option><option value="CD278 (ICOS)">CD278 (ICOS)</option><option value="HLA-DR">HLA-DR</option><option value="PD1">PD1</option><option value="PDL1">PDL1</option><option value="CD21">CD21</option><option value="CD11b">CD11b</option><option value="PAX5">PAX5</option><option value="CD38">CD38</option><option value="EBVEaD">EBVEaD</option><option value="CD8">CD8</option><option value="CD44">CD44</option><option value="TIM3">TIM3</option><option value="Ki67">Ki67</option><option value="Pan-Cytokeratin">Pan-Cytokeratin</option><option value="CD68">CD68</option></select>  
    <br>
     
    <!-- membrane markers, needs to populated in template -->
    
        <label for="membrane_markers">Choose Membrane Channel Markers:</label>
        <select multiple="" name="membrane_markers" id="membrane_markers" required=""><option value="DAPI">DAPI</option><option value="LMP1">LMP1</option><option value="HLA-A">HLA-A</option><option value="CD4">CD4</option><option value="LAG3">LAG3</option><option value="CD20">CD20</option><option value="E1BS (EBNA1)">E1BS (EBNA1)</option><option value="tp (LMP2A)">tp (LMP2A)</option><option value="Vimentin">Vimentin</option><option value="CD30">CD30</option><option value="E-cadherin">E-cadherin</option><option value="CD31">CD31</option><option value="EBNA2">EBNA2</option><option value="CD45RO">CD45RO</option><option value="SMA">SMA</option><option value="CD3e">CD3e</option><option value="IDO1">IDO1</option><option value="CD34">CD34</option><option value="CD11c">CD11c</option><option value="GranzymeB">GranzymeB</option><option value="CD19">CD19</option><option value="CollagenIV">CollagenIV</option><option value="CD79a">CD79a</option><option value="CD14">CD14</option><option value="FoxP3">FoxP3</option><option value="CD57">CD57</option><option value="CD45">CD45</option><option value="CD163">CD163</option><option value="CD278 (ICOS)">CD278 (ICOS)</option><option value="HLA-DR">HLA-DR</option><option value="PD1">PD1</option><option value="PDL1">PDL1</option><option value="CD21">CD21</option><option value="CD11b">CD11b</option><option value="PAX5">PAX5</option><option value="CD38">CD38</option><option value="EBVEaD">EBVEaD</option><option value="CD8">CD8</option><option value="CD44">CD44</option><option value="TIM3">TIM3</option><option value="Ki67">Ki67</option><option value="Pan-Cytokeratin">Pan-Cytokeratin</option><option value="CD68">CD68</option></select> 
    <br>
     
        <button type="submit" class="btn btn-primary">Submit</button>
    </form>

    
    <script>
        experiment_increment = 0
        var workflow_id = ''
        var workflow_bucket_name = ''
        var experiment_data_bucket_name = ''
        // Input experimental data object passed by templating engine
        let experimental_data = JSON.parse('[{"channel_markers": ["DAPI", "LMP1", "HLA-A", "CD4", "LAG3", "CD20", "E1BS (EBNA1)", "tp (LMP2A)", "Vimentin", "CD30", "E-cadherin", "CD31", "EBNA2", "CD45RO", "SMA", "CD3e", "IDO1", "CD34", "CD11c", "GranzymeB", "CD19", "CollagenIV", "CD79a", "CD14", "FoxP3", "CD57", "CD45", "CD163", "CD278 (ICOS)", "HLA-DR", "PD1", "PDL1", "CD21", "CD11b", "PAX5", "CD38", "EBVEaD", "CD8", "CD44", "TIM3", "Ki67", "Pan-Cytokeratin", "CD68"], "experiment_name": "test1010", "tiff_name": "vignetteRegion.ome.tiff"}]');
        // Input state control object passed by templating engine
        let inputSelection = JSON.parse('{"membrane_markers": true, "nuclear_markers": true, "nuclear_stain": true, "protein_channel_markers": true, "tissue_micro_array": true}');

        // experimental_data = rawdata.data

        
        // Event Listener for handling form submission
        var myform = document.getElementById("experimentalDataForm");
        myform.addEventListener("submit", submitForm);
        initialiseForm()

        // Function for handling cylcing through experiments
        function cycleExperiments(increment) {
            if (experiment_increment + increment >= experimental_data.length || experiment_increment + increment < 0) return;
            experiment_increment += increment;
            initialiseForm();
        }


        function initialiseForm() {

            currentExperiment = experimental_data[experiment_increment]
            // Set experimental name display
            document.getElementById('experiment_data_id').setAttribute("value",currentExperiment.experiment_name)

            

            // Populate raw data name
            document.getElementById('tissue_micro_array').setAttribute("value",currentExperiment.tiff_name)
            
            // Populate nuclear Stain
            if (inputSelection.nuclear_stain) {
                document.getElementById('nuclear_stain').innerHTML = ''
                currentExperiment.channel_markers.forEach(element => {
                var message = document.createElement('option')
                message.setAttribute("value",element);
                var content = document.createTextNode(element)
                message.appendChild(content)
                document.getElementById('nuclear_stain').appendChild(message)
            });}

            // Populate nuclear markers
            if (inputSelection.nuclear_markers){
            document.getElementById('nuclear_markers').innerHTML = ''
            currentExperiment.channel_markers.forEach(element => {
                var message = document.createElement('option')
                message.setAttribute("value",element);
                var content = document.createTextNode(element)
                message.appendChild(content)
                document.getElementById('nuclear_markers').appendChild(message)

            });}

            // Populate membrane markers
            if (inputSelection.membrane_markers){
            document.getElementById('membrane_markers').innerHTML = ''
            currentExperiment.channel_markers.forEach(element => {
                var message = document.createElement('option')
                message.setAttribute("value",element);
                var content = document.createTextNode(element)
                message.appendChild(content)
                document.getElementById('membrane_markers').appendChild(message)

            });}
        }

    
        // Function for submitting form data.
        function submitForm(e) {
            e.preventDefault();
            var myform =    document.getElementById("experimentalDataForm");
            var formData = new FormData(myform);
            
            // Convert form data into appropriate data for back end
            var object = {
                'system_parameters' : {
                    'workflow_id': workflow_id,
                    'workflow_bucket_name' : workflow_bucket_name,
                    'experiment_data_bucket_name': experiment_data_bucket_name
                },
                'workflow_parameters' : {
                'experiment_data_id' : null,
                }
                // 'tissue_micro_array' : null,
            }

            if (inputSelection.nuclear_stain){
                object['workflow_parameters']['nuclear_stain'] = null
            }

            if (inputSelection.nuclear_markers) {
                object['workflow_parameters']['nuclear_markers'] = []
            }

            if (inputSelection.membrane_markers) {
                object['workflow_parameters']['membrane_markers'] = []
            }


            // Iterate over form and add it to new object
            for(var pair of formData.entries()){
                if (pair[0] != 'tissue_micro_array'){
                    try {
                    object['workflow_parameters'][pair[0]].push(pair[1]);
                    } catch (error) {
                        if(error instanceof TypeError) {
                            object['workflow_parameters'][pair[0]] = pair[1];
                        } 
                    }
                }  
            }

            // Send to backend
            console.log(object)

            // Convert to a JSON String
            const request_body = JSON.stringify(object);
            var request = new XMLHttpRequest();
            // endpoint be populated on the server side
            request.open('POST', "http://192.168.64.2/services-api/start/init-tma/submit/65f1b2742db6bd10f49d5db2")
            request.onreadystatechange = function () {
                    if (this.readyState === 4) {
                        console.log('Status:', this.status);
                        console.log('Headers:', this.getAllResponseHeaders());
                        console.log('Body:', this.responseText);

                        let redirect = JSON.parse(this.responseText)
                        console.log(redirect)
                        window.location.href=redirect.url
                    }
                };
            console.log(request_body)
            request.setRequestHeader("Content-Type", "application/json");
            request.send(request_body)
        }

       
        
    console.log(document.referrer)

    </script>
    

<script>mendeleyWebImporter = {
  downloadPdfs(e,t) { return this._call('downloadPdfs', [e,t]); },
  open() { return this._call('open', []); },
  setLoginToken(e) { return this._call('setLoginToken', [e]); },
  _call(methodName, methodArgs) {
    const id = Math.random();
    window.postMessage({ id, token: '0.07905888797898775', methodName, methodArgs }, 'http://192.168.64.2');
    return new Promise(resolve => {
      const listener = window.addEventListener('message', event => {
        const data = event.data;
        if (typeof data !== 'object' || !('result' in data) || data.id !== id) return;
        window.removeEventListener('message', listener);
        resolve(data.result);
      });
    });
  }
};</script></body></html>